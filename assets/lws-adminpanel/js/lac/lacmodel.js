(function(a){a.widget("lws.lac_model",{options:{mode:"autocomplete",resChange:undefined,resLoad:undefined,origin:undefined,count:20},_create:function(){this.originsList=[];this.currentOrigin={};this.flatSource={};this.labelSource={};this.dataSource={};a.ajaxSettings.cache=false;this._setSource();this._setOrigin(this.options.origin)},_bind:function(b,c,d){return function(){return b.apply(c,d)}},_setSource:function(){var b=a(this.options.origin.element);this.dataSource={};this.ajax={};if(b[0].nodeName=="SELECT"){for(var c=0;c<b[0].options.length;c++){var d={};d.value=b[0].options[c].value;d.label=b[0].options[c].text;this.dataSource[b[0].options[c].value]=d}}if(this.options.origin.options.source!=undefined){this.dataSource=this.options.origin.options.source}if(b.data("source")!=undefined&&b.data("source")!=""){this.dataSource=lwsBase64.toObj(b.data("source"))}if(this.options.origin.options.ajax!=undefined){this.ajax.action=this.options.origin.options.ajax}if(b.data("ajax")!=undefined){this.ajax.action=b.data("ajax")}if(this.options.origin.options.spec!=undefined){this.ajax.spec=this.options.origin.options.spec}if(b.data("sourceurl")!=undefined){this.ajax.sourceurl=b.data("sourceurl")}if(this.options.origin.options.minsearch!=undefined){this.options.minsearch=this.options.origin.options.minsearch}if(b.data("minsearch")!=undefined){this.options.minsearch=b.data("minsearch")}if(this.options.origin.options.minoption!=undefined){this.options.minoption=this.options.origin.options.minoption}if(b.data("minoption")!=undefined){this.options.minoption=b.data("minoption")}if(this.options.origin.options.minlength!=undefined){this.options.minlength=this.options.origin.options.minlength}if(b.data("minlength")!=undefined){this.options.minlength=b.data("minlength")}},_setOrigin:function(b){var c=b.uuid;if(this.originsList[c]==""||this.originsList[c]==undefined){this.originsList[c]={};this.originsList[c].target=b;this.originsList[c].searched="";this.originsList[c].page=0;this.originsList[c].count=this.options.count}this.currentOrigin=this.originsList[c]},showMore:function(b){this._setOrigin(b);this.currentOrigin.page+=1;this._remoteSource(this.currentOrigin.searched)},returnLabels:function(b,c){this.resCount=b.length;if(c!=undefined&&c!=""){this._setOrigin(c)}result=[];if(b!=undefined&&b!=false){result=this._recursiveSearch(b,this.dataSource,true);if(this.resCount>0){if((this.ajax.sourceurl!=undefined&&this.ajax.sourceurl!="")||(this.ajax.action!=undefined&&this.ajax.action!="")){this._remoteSource(b,"init",true,true)}}for(let i=0;i<b.length;i++){if(!result[b[i]]){result[b[i]]={};result[b[i]].value=b[i];result[b[i]].label=b[i];result[b[i]].html="";this.flatSource[b[i]]=result[b[i]];this.dataSource[b[i]]=result[b[i]]}}}this._sendBack(result,"init")},isSubChain:function(c,b){if(b!=undefined&&b!=""){this._setOrigin(b)}if(this.currentOrigin.searched.toLowerCase().substring(0,c.length)==c.toLowerCase()&&c.length<this.currentOrigin.searched.length){return true}return false},getValuesFromLabels:function(b,c){result=[];for(let i=0;i<b.length;i++){res=this.labelSource[b[i]];if(res==undefined||res==""){if(c==undefined||!c){res={};res.value=b[i];res.label=b[i];res.html="";result.push(res)}}else{result.push(res)}}return result},research:function(c,b,d){if((c==""||c==undefined)&&(d==undefined||d==false)){return}if(b!=undefined&&b!=""){this._setOrigin(b)}if(d==true){this._remoteSource("")}else{if(c.length<this.options.minlength){return}if(c.toLowerCase().substring(0,this.currentOrigin.searched.length)==this.currentOrigin.searched.toLowerCase){resultData=this._recursiveSearch(c,this.dataSource,false);this._sendBack(resultData,"ok")}else{this.currentOrigin.searched=c;if(c.length>this.options.minsearch&&(this.ajax.sourceurl!=undefined||this.ajax.action!=undefined)){this._remoteSource(c)}else{resultData=this._recursiveSearch(c,this.dataSource,false);if(resultData.length<this.options.minoption&&(this.ajax.sourceurl!=undefined||this.ajax.action!=undefined)){this._remoteSource(c)}else{this._sendBack(resultData,"ok")}}}}},getSource:function(){return this.dataSource},addToSource:function(c){for(var b in c){if(this.flatSource[b]==""||this.flatSource[b]==undefined){res={};res.value=c[b];res.label=c[b];this.flatSource[b]=res;res.html="";res.parent="";this.dataSource[b]=res}}},_recursiveSearch:function(g,f,c){var b={};for(var e in f){this.flatSource[e]=jQuery.extend({},f[e]);this.labelSource[f[e].label]=jQuery.extend({},f[e]);if(f[e].group!=undefined){retour=this._recursiveSearch(g,f[e].group,c);if(!jQuery.isEmptyObject(retour)){b[e]=new Object(f[e]);b[e].group=retour}}else{if(c==true){for(var d=0;d<g.length;d++){if(g[d]==e){b[e]=f[e];this.resCount-=1}}}else{researched=f[e].label.toLowerCase();if(a.isArray(g)){for(let d=0;d<g.length;d++){if(this.options.mode=="autocomplete"){if(researched.substring(0,g.length)==g[d].toLowerCase()){b[e]=f[e];this.resCount-=1}}else{if(this.options.mode=="research"){if(researched.search(g.toLowerCase())!=-1){b[e]=f[e];this.resCount-=1}}}}}else{if(this.options.mode=="autocomplete"){if(researched.substring(0,g.length)==g.toLowerCase()){b[e]=f[e]}}else{if(this.options.mode=="research"){if(researched.search(g.toLowerCase())!=-1){b[e]=f[e]}}}}}}}return b},_sendBack:function(d,b,c){result=[d,b,c];if(this.options.resChange!=undefined){this.options.resChange.fn.apply(this.currentOrigin.target,[result])}},_remoteSource:function(f,b,d){if(this.options.resLoad!=undefined){this.options.resLoad.fn.apply(this.currentOrigin.target)}var c={action:this.ajax.action,term:f,fromValue:d,count:this.currentOrigin.count,page:this.currentOrigin.page};if(this.currentOrigin.target.element.data("spec")!=undefined){c.spec=this.currentOrigin.target.element.data("spec")}ajax_url=(this.ajax.sourceurl!=undefined)?this.ajax.sourceurl:lws_ajax_url;var e=this;a.getJSON(ajax_url,c,function(g){resultData=[];if(null==g){status="Autocomplete ressource error."}else{if(0===g){status="Autocomplete action not found."}else{e.dataSource=a.extend(true,e.dataSource,g);var h=(Object.keys(g).length==e.currentOrigin.count)?true:false;if(b!=undefined){status="init";e.resCount=f.length;resultData=e._recursiveSearch(f,e.dataSource,true);if(e.resCount>0){console.log("some items couldn't be found on datasource")}}else{status="ok";e.currentOrigin.searched=f;resultData=e._recursiveSearch(f,e.dataSource,false)}}}e._sendBack(resultData,status,h)}).fail(function(h,j,g){resultData=[];status="Autocomplete loading error, status: "+j+", error: "+g;e._sendBack(resultData,status)})}})})(jQuery);